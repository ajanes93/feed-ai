name: OQ Digest Cron

on:
  schedule:
    # Daily: fetch external data, articles, and generate score
    - cron: "30 5 * * *"
    # Weekly maintenance (Sundays): clean up old data
    - cron: "0 4 * * 0"

  workflow_dispatch:
    inputs:
      action:
        description: "Action to run"
        required: true
        type: choice
        options:
          - full-run
          - fetch
          - score
          - rescore
          - delete-score
          - predigest
          - fetch-external
          - maintenance

env:
  OQ_WORKER_URL: ${{ secrets.OQ_WORKER_URL }}
  OQ_ADMIN_KEY: ${{ secrets.OQ_ADMIN_KEY }}

jobs:
  daily:
    if: github.event.schedule == '30 5 * * *' || (github.event_name == 'workflow_dispatch' && inputs.action == 'full-run')
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Fetch external data (SanityHarness, SWE-bench, FRED)
        run: |
          echo "--- SanityHarness ---"
          curl -sf -X POST "$OQ_WORKER_URL/api/fetch-sanity" \
            -H "Authorization: Bearer $OQ_ADMIN_KEY"
          echo ""

          echo "--- SWE-bench ---"
          curl -sf -X POST "$OQ_WORKER_URL/api/fetch-swebench" \
            -H "Authorization: Bearer $OQ_ADMIN_KEY"
          echo ""

          echo "--- FRED ---"
          curl -s -o /dev/null -w "%{http_code}" -X POST "$OQ_WORKER_URL/api/fetch-fred" \
            -H "Authorization: Bearer $OQ_ADMIN_KEY" || true

      - name: Fetch articles
        run: |
          curl -sf -X POST "$OQ_WORKER_URL/api/fetch" \
            -H "Authorization: Bearer $OQ_ADMIN_KEY"

      - name: Generate daily score
        run: |
          curl -sf -X POST "$OQ_WORKER_URL/api/score" \
            -H "Authorization: Bearer $OQ_ADMIN_KEY"

  maintenance:
    if: github.event.schedule == '0 4 * * 0' || (github.event_name == 'workflow_dispatch' && inputs.action == 'maintenance')
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Run weekly maintenance cleanup
        run: |
          curl -sf -X POST "$OQ_WORKER_URL/api/maintenance" \
            -H "Authorization: Bearer $OQ_ADMIN_KEY"

  # Individual actions for workflow_dispatch
  fetch-only:
    if: github.event_name == 'workflow_dispatch' && inputs.action == 'fetch'
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Fetch articles
        run: |
          curl -sf -X POST "$OQ_WORKER_URL/api/fetch" \
            -H "Authorization: Bearer $OQ_ADMIN_KEY"

  score-only:
    if: github.event_name == 'workflow_dispatch' && inputs.action == 'score'
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Generate daily score
        run: |
          curl -sf -X POST "$OQ_WORKER_URL/api/score" \
            -H "Authorization: Bearer $OQ_ADMIN_KEY"

  rescore:
    if: github.event_name == 'workflow_dispatch' && inputs.action == 'rescore'
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Delete existing score
        run: |
          curl -sf -X POST "$OQ_WORKER_URL/api/delete-score" \
            -H "Authorization: Bearer $OQ_ADMIN_KEY"
      - name: Pre-digest articles
        run: |
          curl -sf -X POST "$OQ_WORKER_URL/api/predigest" \
            -H "Authorization: Bearer $OQ_ADMIN_KEY"
      - name: Generate new score
        run: |
          curl -sf -X POST "$OQ_WORKER_URL/api/score" \
            -H "Authorization: Bearer $OQ_ADMIN_KEY"

  delete-score:
    if: github.event_name == 'workflow_dispatch' && inputs.action == 'delete-score'
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Delete today's score
        run: |
          curl -sf -X POST "$OQ_WORKER_URL/api/delete-score" \
            -H "Authorization: Bearer $OQ_ADMIN_KEY"

  predigest:
    if: github.event_name == 'workflow_dispatch' && inputs.action == 'predigest'
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Pre-digest articles
        run: |
          curl -sf -X POST "$OQ_WORKER_URL/api/predigest" \
            -H "Authorization: Bearer $OQ_ADMIN_KEY"

  fetch-external:
    if: github.event_name == 'workflow_dispatch' && inputs.action == 'fetch-external'
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Fetch external data sources
        run: |
          echo "--- SanityHarness ---"
          curl -sf -X POST "$OQ_WORKER_URL/api/fetch-sanity" \
            -H "Authorization: Bearer $OQ_ADMIN_KEY"
          echo ""

          echo "--- SWE-bench ---"
          curl -sf -X POST "$OQ_WORKER_URL/api/fetch-swebench" \
            -H "Authorization: Bearer $OQ_ADMIN_KEY"
          echo ""

          echo "--- FRED ---"
          curl -s -o /dev/null -w "%{http_code}" -X POST "$OQ_WORKER_URL/api/fetch-fred" \
            -H "Authorization: Bearer $OQ_ADMIN_KEY" || true
